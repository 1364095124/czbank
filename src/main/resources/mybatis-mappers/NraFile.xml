<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.relesee.dao.NraFileDao">


    <insert id="insertNraFile">
        INSERT INTO
            nrafile(
                id,
                fileName,
                queueNo,
                uploadTime,
                uploader,
                restorePath,
                isDel,
                note,
                isQualityCustomer,
                statusCode,
                isPriority,
                auditor
            )
        VALUES
            (
                #{id},
                #{fileName},
                (SELECT no FROM
                    (
                    SELECT
                        MAX(queueNo)+1 no

                    FROM
                        nrafile
                    ) AS temp
                ),
                NOW(),
                #{uploader},
                #{restorePath},
                0,
                #{note},
                #{isQualityCustomer},
                0,
                0,
                NULL
            )
    </insert>

    <select id="selectNraQueue" resultType="com.relesee.domains.NraFile">
        SELECT
            id,
            filename,
            queueNo,
            isQualityCustomer,
            uploadTime,
            uploader,
            userName,
            restorePath,
            statusCode,
            isPriority,
            note
        FROM
            nrafile
        INNER JOIN
            user
        ON
            nrafile.uploader = user.userId
        WHERE
            isDel = '0'
        AND
            userState > 0
        AND
            queueNo >= 1
        AND
            fileName LIKE CONCAT('%', #{fileName} ,'%')
        <if test="beginDate != null and endDate != null">
        AND
            uploadTime
        BETWEEN
            #{beginDate} AND #{endDate}
        </if>
        <if test="beginDate != null and endDate == null">
        AND
            DATE_FORMAT(uploadtime, '%Y-%m-%d') = DATE_FORMAT(#{beginDate}, '%Y-%m-%d')
        </if>
        <if test="endDate != null and beginDate == null">
        AND
            DATE_FORMAT(uploadtime, '%Y-%m-%d') = DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        ORDER BY
            queueNo
    </select>

    <select id="selectNraHistory" resultType="com.relesee.domains.NraFile">
        SELECT
            id,
            filename,
            queueNo,
            isQualityCustomer,
            uploadTime,
            uploader,
            restorePath,
            statusCode,
            isPriority,
            note
        FROM
            nrafile
        INNER JOIN
            user
        ON
            nrafile.uploader = user.userId
        WHERE
            userId = #{userId}
        AND
        fileName LIKE CONCAT('%', #{fileName} ,'%')
        <if test="beginDate != null and endDate != null">
            AND
            uploadTime
            BETWEEN
            #{beginDate} AND #{endDate}
        </if>
        <if test="beginDate != null and endDate == null">
            AND
            DATE_FORMAT(uploadtime, '%Y-%m-%d') = DATE_FORMAT(#{beginDate}, '%Y-%m-%d')
        </if>
        <if test="endDate != null and beginDate == null">
            AND
            DATE_FORMAT(uploadtime, '%Y-%m-%d') = DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        ORDER BY
            uploadTime
    </select>

    <update id="deleteNraFileById" parameterType="String">
        UPDATE
            nrafile
        SET
            --isDel = 1,不用逻辑删除
            statusCode = #{statusCode}
        WHERE
            id = #{id};
        UPDATE
            nrafile
        SET
            queueNo = queueNo - 1
        WHERE
            queueNo > (
                SELECT queueNo FROM(
                    SELECT
                        queueNo
                    FROM
                        nrafile
                    WHERE
                        id = #{id}
                ) as temp
            );
        UPDATE
            nrafile
        SET
            queueNo = 0
        WHERE
            id = #{id}
    </update>

    <select id="selectNraFileById" parameterType="String" resultType="com.relesee.domains.NraFile">
        SELECT
            id,
            filename,
            queueNo,
            isQualityCustomer,
            uploadTime,
            uploader,
            restorePath,
            statusCode,
            isPriority,
            note,
            auditor
        FROM
            nrafile
        WHERE
            id = #{id}
    </select>

    <update id="updateStatusRefused" parameterType="com.relesee.domains.NraFile">
        UPDATE
            nrafile
        SET
            statusCode = #{statusCode}
        WHERE
            id = #{uploader}
    </update>

    <update id="updateStatusPassed" parameterType="com.relesee.domains.NraFile">
        UPDATE
            nrafile
        SET
            statusCode = #{statusCode}
        WHERE
            id = #{uploader}
    </update>

    <select id="selectForAudit" resultType="com.relesee.domains.NraFile">
        SELECT
            id,
            queueNo,
            fileName,
            isQualityCustomer,
            uploadTime,
            uploader,
            restorePath,
            statusCode,
            isPriority,
            note,
            auditor,
            userName
        FROM
            nrafile
        INNER JOIN
            user
        ON
            nrafile.uploader = user.userId
        WHERE
            isDel = 0
        AND
            statusCode = 1
        AND
            queueNo >= 1
        AND
            auditor = #{auditor}
        ORDER BY
            queueNo
        LIMIT
            0,#{amount}
    </select>

    <update id="updateNraAuditor">
        UPDATE
            nrafile
        SET
            statusCode = #{statusCode},
            auditor = #{auditor}
        WHERE
            id
            IN(
                SELECT id FROM
                (
                    SELECT
                        id
                    FROM
                        nrafile
                    WHERE
                        isDel = 0
                    AND
                        statusCode = 0
                    AND
                        queueNo >= 1
                    ORDER BY
                        queueNo
                    LIMIT
                        0,#{amount}
                ) temp
            )
    </update>

    <select id="selectLocked" parameterType="String" resultType="com.relesee.domains.NraFile">
        SELECT
            id,
            queueNo,
            fileName,
            isQualityCustomer,
            uploadTime,
            uploader,
            restorePath,
            statusCode,
            isPriority,
            note,
            auditor,
            userName
        FROM
            nrafile
        INNER JOIN
            user
        ON
            nrafile.uploader = user.userId
        WHERE
            isDel = 0
        AND
            statusCode = 1
        AND
            queueNo >= 1
        AND
            auditor = #{userId}
        ORDER BY
            queueNo
    </select>

    <select id="serializeQueue">
        --本次查询需要用到的变量
        SET count = NULL;--状态码大于1的申请数
        -------------------------------------------------
        SELECT
            @count := COUNT(*) AS count
        FROM
            nraFile
        WHERE
            statusCode > 1
        AND
            isDel = 0
        AND
            auditor != NULL;
        --------------------------------------------------
        --将状态码大于1的（不处于排队中和已锁定状态的申请）队列号设为0
        UPDATE
            nrafile
        SET
            queueNo = 0
        WHERE
            statusCode > 1
        AND
            isDel = 0
        AND
            auditor IS NOT NULL;
        ----------------------------------------------------
    </select>
</mapper>